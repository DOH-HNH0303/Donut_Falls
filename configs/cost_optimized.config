/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Cost-Optimized Configuration for Donut Falls
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Optimized resource allocation to reduce costs on cloud platforms like Seqera
----------------------------------------------------------------------------------------
*/

// Reduce default resource allocations
process {
    // Reduce retry attempts to avoid wasted compute on failed jobs
    maxRetries = 1
    errorStrategy = { task.attempt < 2 ? 'retry' : 'terminate'}

    // Cost-optimized resource labels
    withLabel:process_single {
        cpus   = { 1 }
        memory = { 4.GB }
        time   = { 20.m * task.attempt}
    }
    withLabel:process_low {
        cpus   = { 2 }
        memory = { 8.GB }
        time   = { 1.h * task.attempt }
    }
    withLabel:process_medium {
        cpus   = { 4 }
        memory = { 16.GB }
        time   = { 2.h }
    }
    withLabel:process_high {
        cpus   = { 8 }
        memory = { 32.GB }
        time   = { 8.h * task.attempt }
    }

    // Reduce resources for QC processes
    withName:fastp {
        cpus   = { 2 }
        memory = { 4.GB }
        time   = { 30.m }
    }

    withName:seqkit {
        cpus   = { 1 }
        memory = { 2.GB }
        time   = { 15.m }
    }

    withName:mash {
        cpus   = { 2 }
        memory = { 4.GB }
        time   = { 15.m }
    }

    // Reduce resources for post-assembly processes
    withName:busco {
        cpus   = { 4 }
        memory = { 16.GB }
        time   = { 30.m }
    }

    withName:circulocov {
        cpus   = { 4 }
        memory = { 16.GB }
        time   = { 30.m }
    }

    withName:bandage {
        cpus   = { 1 }
        memory = { 2.GB }
        time   = { 5.m }
    }

    withName:gfastats {
        cpus   = { 2 }
        memory = { 4.GB }
        time   = { 10.m }
    }

    // ONT Coverage analysis - cost-optimized settings
    withName:ONT_COVERAGE {
        cpus   = { 2 }              // Reduced CPUs for cost optimization
        memory = { 4.GB }           // Reduced memory for cost optimization
        time   = { 45.m }           // Increased time to compensate for reduced resources
        errorStrategy = { task.attempt < 3 ? 'retry' : 'terminate' }
        maxRetries = 2
    }

    // WAPHL analysis processes
    withName:MASH_TAXA {
        cpus   = { 2 }
        memory = { 8.GB }  // Minimum 8GB required for RefSeq database operations
        time   = { 15.m }
    }

    withName:FINAL_SUMMARY {
        cpus   = { 1 }
        memory = { 2.GB }
        time   = { 10.m }
    }
}

// Optimize for smaller datasets
params {
    max_memory = '32.GB'
    max_cpus = 8
    max_time = '8.h'
}